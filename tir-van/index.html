<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora TIR - meskeIA</title>
    <meta name="description" content="¬øEs rentable tu proyecto de inversi√≥n? Calcula TIR (Tasa Interna de Retorno) y VAN online gratis. Analiza la viabilidad financiera de forma profesional.">
    <link rel="canonical" href="https://meskeia.com/tir-van/calculadora-tir/">
    <style>
        :root {
            --color-primary: #2E86AB;
            --color-secondary: #48A9A6;
            --color-accent: #7FB3D3;
            --color-background: #f4f7f9;
            --color-surface: #ffffff;
            --color-text: #2C3E50;
            --color-text-secondary: #5a6c7d;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-error: #dc3545;
            --border-radius: 8px;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-accent);
        }

        .header h1 {
            color: var(--color-primary);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--color-text-secondary);
            font-size: 1.1em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--color-primary);
        }

        input[type="number"] {
            padding: 12px;
            border: 2px solid #e5e5e5;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .help-text {
            font-size: 0.9em;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }

        .calculate-btn {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .calculate-btn:hover {
            background: #5fa3c5;
        }

        .calculate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-accent);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e5e5;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: var(--color-primary);
        }

        .result-value {
            font-size: 1.2em;
            font-weight: 700;
        }

        .tir-value {
            color: var(--color-accent);
            font-size: 1.5em;
        }

        .comparison {
            margin-top: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
        }

        .comparison.positive {
            background: rgba(40, 167, 69, 0.1);
            border-left: 4px solid var(--color-success);
        }

        .comparison.negative {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid var(--color-error);
        }

        .comparison.neutral {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid var(--color-warning);
        }

        .error {
            color: var(--color-error);
            background: rgba(220, 53, 69, 0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-error);
            margin-top: 20px;
        }

        .cash-flow-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }

        .cash-flow-table th,
        .cash-flow-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #e5e5e5;
        }

        .cash-flow-table th {
            background: var(--color-primary);
            color: white;
        }

        .negative {
            color: var(--color-error);
        }

        .positive {
            color: var(--color-success);
        }

        .scenarios-section {
            margin-top: 30px;
        }

        .scenarios-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .scenarios-header h3 {
            color: var(--color-primary);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .scenario-card {
            background: var(--color-surface);
            border: 2px solid #e5e5e5;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
        }

        .scenario-card.optimista {
            border-color: var(--color-success);
            background: rgba(40, 167, 69, 0.05);
        }

        .scenario-card.realista {
            border-color: var(--color-accent);
            background: rgba(255, 193, 7, 0.1);
        }

        .scenario-card.pesimista {
            border-color: var(--color-error);
            background: rgba(220, 53, 69, 0.1);
        }

        .scenario-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .scenario-card.optimista .scenario-title {
            color: var(--color-success);
        }

        .scenario-card.realista .scenario-title {
            color: var(--color-accent);
        }

        .scenario-card.pesimista .scenario-title {
            color: var(--color-error);
        }

        .scenario-tir {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .scenario-details {
            font-size: 0.9em;
            color: var(--color-text-secondary);
            margin-top: 10px;
        }

        .sensitivity-section {
            margin-top: 30px;
        }

        .sensitivity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .sensitivity-table th,
        .sensitivity-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e5e5e5;
        }

        .sensitivity-table th {
            background: var(--color-primary);
            color: white;
            font-weight: 600;
        }

        .sensitivity-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .sensitivity-table .center-row {
            background-color: var(--color-accent) !important;
            color: white;
            font-weight: bold;
        }

        .sensitivity-positive {
            background-color: rgba(40, 167, 69, 0.1) !important;
            color: var(--color-success);
            font-weight: 600;
        }

        .sensitivity-negative {
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: var(--color-error);
            font-weight: 600;
        }

        .equilibrium-info {
            background: #f8f9fa;
            border-left: 4px solid var(--color-accent);
            padding: 15px;
            margin-top: 20px;
            border-radius: var(--border-radius);
        }

        .equilibrium-info h4 {
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .scenarios-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .sensitivity-table {
                font-size: 0.9em;
            }
        }

        /* Logo meskeIA - Componente reutilizable */
        .meskeia-logo-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(46, 134, 171, 0.2);
            border-radius: 12px;
            padding: 8px 16px;
            box-shadow: 0 4px 20px rgba(46, 134, 171, 0.1);
            transition: all 0.3s ease;
        }

        .meskeia-logo-container:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 25px rgba(46, 134, 171, 0.15);
        }

        .meskeia-logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #2E86AB 0%, #48A9A6 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .meskeia-logo-icon::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            top: 10px;
            left: 10px;
        }

        .meskeia-logo-icon::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #2E86AB;
            border-radius: 50%;
            top: 13px;
            left: 13px;
        }

        .meskeia-neural-network {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }

        .meskeia-neural-dot {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
        }

        .meskeia-neural-dot:nth-child(1) { top: 4px; left: 6px; }
        .meskeia-neural-dot:nth-child(2) { top: 8px; right: 5px; }
        .meskeia-neural-dot:nth-child(3) { bottom: 6px; left: 4px; }
        .meskeia-neural-dot:nth-child(4) { bottom: 4px; right: 8px; }

        .meskeia-logo-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2C3E50;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .meskeia-logo-text .meske {
            color: #2E86AB;
        }

        .meskeia-logo-text .ia {
            color: #48A9A6;
            font-weight: 700;
            position: relative;
        }

        .meskeia-logo-text .ia::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #48A9A6, #7FB3D3);
            border-radius: 1px;
        }

        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .meskeia-logo-container {
                top: 10px;
                left: 10px;
                padding: 6px 12px;
                gap: 8px;
            }

            .meskeia-logo-icon {
                width: 24px;
                height: 24px;
            }

            .meskeia-logo-icon::before {
                width: 9px;
                height: 9px;
                top: 7.5px;
                left: 7.5px;
            }

            .meskeia-logo-icon::after {
                width: 4px;
                height: 4px;
                top: 10px;
                left: 10px;
            }

            .meskeia-logo-text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Logo meskeIA -->
    <div class="meskeia-logo-container" onclick="window.location.href='../index.html'" style="cursor: pointer;">
        <div class="meskeia-logo-icon">
            <div class="meskeia-neural-network">
                <div class="meskeia-neural-dot"></div>
                <div class="meskeia-neural-dot"></div>
                <div class="meskeia-neural-dot"></div>
                <div class="meskeia-neural-dot"></div>
            </div>
        </div>
        <div class="meskeia-logo-text">
            <span class="meske">meske</span><span class="ia">IA</span>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä Calculadora TIR</h1>
            <p>Calcula la Tasa Interna de Retorno de tu inversi√≥n</p>
        </div>

        <form id="tirForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="inversionInicial">Inversi√≥n Inicial (‚Ç¨)</label>
                    <input type="number" id="inversionInicial" step="0.01" placeholder="100000" required>
                    <span class="help-text">Importe negativo (salida de dinero)</span>
                </div>

                <div class="form-group">
                    <label for="rentaAnual">Renta Anual (‚Ç¨)</label>
                    <input type="number" id="rentaAnual" step="0.01" placeholder="5000" required>
                    <span class="help-text">Ingresos anuales esperados</span>
                </div>

                <div class="form-group">
                    <label for="numeroAnios">N√∫mero de A√±os</label>
                    <input type="number" id="numeroAnios" min="1" max="50" placeholder="20" required>
                    <span class="help-text">Duraci√≥n de la inversi√≥n</span>
                </div>

                <div class="form-group">
                    <label for="valorFinal">Valor Final (‚Ç¨)</label>
                    <input type="number" id="valorFinal" step="0.01" placeholder="10000" required>
                    <span class="help-text">Valor residual al final</span>
                </div>

                <div class="form-group">
                    <label for="tipoMercado">Tipo de Inter√©s del Mercado (%)</label>
                    <input type="number" id="tipoMercado" step="0.01" placeholder="3.5" required>
                    <span class="help-text">Para comparar con el TIR obtenido</span>
                </div>
            </div>

            <button type="submit" class="calculate-btn">Calcular TIR</button>
        </form>

        <div id="results" class="results" style="display: none;">
            <div class="result-item">
                <span class="result-label">TIR (Tasa Interna de Retorno):</span>
                <span class="result-value tir-value" id="tirResult">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Tipo de Inter√©s del Mercado:</span>
                <span class="result-value" id="mercadoResult">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">VAN al tipo del mercado:</span>
                <span class="result-value" id="vanResult">-</span>
            </div>

            <div id="comparison" class="comparison">
                <strong id="comparisonText"></strong>
            </div>

            <table class="cash-flow-table">
                <thead>
                    <tr>
                        <th>A√±o</th>
                        <th>Flujo de Caja (‚Ç¨)</th>
                        <th>Valor Presente (‚Ç¨)</th>
                    </tr>
                </thead>
                <tbody id="cashFlowTable">
                </tbody>
            </table>
        </div>

        <!-- Secci√≥n de M√∫ltiples Escenarios -->
        <div id="scenariosSection" class="scenarios-section" style="display: none;">
            <div class="scenarios-header">
                <h3>üìä An√°lisis por Escenarios</h3>
                <p>Comparaci√≥n entre escenarios optimista, realista y pesimista</p>
            </div>
            <div class="scenarios-grid" id="scenariosGrid">
                <!-- Los escenarios se generar√°n din√°micamente -->
            </div>
        </div>

        <!-- Secci√≥n de An√°lisis de Sensibilidad -->
        <div id="sensitivitySection" class="sensitivity-section" style="display: none;">
            <div class="scenarios-header">
                <h3>üéØ An√°lisis de Sensibilidad</h3>
                <p>Variaci√≥n del TIR seg√∫n cambios en las rentas anuales</p>
            </div>
            <table class="sensitivity-table">
                <thead>
                    <tr>
                        <th>Variaci√≥n Renta</th>
                        <th>Nueva Renta (‚Ç¨)</th>
                        <th>TIR</th>
                        <th>vs. Mercado</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="sensitivityTable">
                </tbody>
            </table>
            <div class="equilibrium-info" id="equilibriumInfo">
                <!-- Informaci√≥n de punto de equilibrio -->
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        class TIRCalculator {
            constructor() {
                this.form = document.getElementById('tirForm');
                this.resultsDiv = document.getElementById('results');
                this.errorDiv = document.getElementById('error');

                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.calculate();
                });
            }

            calculate() {
                try {
                    this.hideError();

                    // Obtener valores del formulario
                    const inversionInicial = parseFloat(document.getElementById('inversionInicial').value);
                    const rentaAnual = parseFloat(document.getElementById('rentaAnual').value);
                    const numeroAnios = parseInt(document.getElementById('numeroAnios').value);
                    const valorFinal = parseFloat(document.getElementById('valorFinal').value);
                    const tipoMercado = parseFloat(document.getElementById('tipoMercado').value) / 100;

                    // Validar inputs
                    if (!this.validateInputs(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado)) {
                        return;
                    }

                    // Construir flujos de caja
                    const cashFlows = this.buildCashFlows(inversionInicial, rentaAnual, numeroAnios, valorFinal);

                    // Calcular TIR
                    const tir = this.calculateTIR(cashFlows);

                    // Calcular VAN al tipo del mercado
                    const van = this.calculateNPV(cashFlows, tipoMercado);

                    // Mostrar resultados
                    this.displayResults(tir, tipoMercado * 100, van, cashFlows, tipoMercado);

                    // Mostrar an√°lisis de escenarios
                    this.displayScenarios(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado);

                    // Mostrar an√°lisis de sensibilidad
                    this.displaySensitivityAnalysis(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado);

                } catch (error) {
                    this.showError('Error en el c√°lculo: ' + error.message);
                }
            }

            validateInputs(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado) {
                if (isNaN(inversionInicial) || inversionInicial <= 0) {
                    this.showError('La inversi√≥n inicial debe ser un valor positivo');
                    return false;
                }

                if (isNaN(rentaAnual) || rentaAnual < 0) {
                    this.showError('La renta anual debe ser un valor no negativo');
                    return false;
                }

                if (isNaN(numeroAnios) || numeroAnios <= 0 || numeroAnios > 50) {
                    this.showError('El n√∫mero de a√±os debe estar entre 1 y 50');
                    return false;
                }

                if (isNaN(valorFinal) || valorFinal < 0) {
                    this.showError('El valor final debe ser un valor no negativo');
                    return false;
                }

                if (isNaN(tipoMercado) || tipoMercado < 0 || tipoMercado > 1) {
                    this.showError('El tipo de inter√©s debe estar entre 0% y 100%');
                    return false;
                }

                return true;
            }

            buildCashFlows(inversionInicial, rentaAnual, numeroAnios, valorFinal) {
                const cashFlows = [];

                // A√±o 0: Inversi√≥n inicial (flujo negativo)
                cashFlows.push(-inversionInicial);

                // A√±os 1 a n-1: Solo rentas anuales
                for (let i = 1; i < numeroAnios; i++) {
                    cashFlows.push(rentaAnual);
                }

                // A√±o n: Renta anual + valor final
                cashFlows.push(rentaAnual + valorFinal);

                return cashFlows;
            }

            calculateTIR(cashFlows) {
                // M√©todo Newton-Raphson para calcular TIR
                let rate = 0.1; // Estimaci√≥n inicial del 10%
                const maxIterations = 1000;
                const tolerance = 1e-10;

                for (let i = 0; i < maxIterations; i++) {
                    const npv = this.calculateNPV(cashFlows, rate);
                    const dnpv = this.calculateDerivativeNPV(cashFlows, rate);

                    if (Math.abs(dnpv) < tolerance) {
                        throw new Error('No se puede calcular el TIR (derivada muy peque√±a)');
                    }

                    const newRate = rate - npv / dnpv;

                    if (Math.abs(newRate - rate) < tolerance) {
                        return newRate;
                    }

                    rate = newRate;

                    // Evitar tasas negativas extremas o muy altas
                    if (rate < -0.99 || rate > 10) {
                        throw new Error('No se puede encontrar una TIR v√°lida para estos flujos de caja');
                    }
                }

                throw new Error('TIR no converge despu√©s de ' + maxIterations + ' iteraciones');
            }

            calculateNPV(cashFlows, rate) {
                let npv = 0;
                for (let i = 0; i < cashFlows.length; i++) {
                    npv += cashFlows[i] / Math.pow(1 + rate, i);
                }
                return npv;
            }

            calculateDerivativeNPV(cashFlows, rate) {
                let derivative = 0;
                for (let i = 1; i < cashFlows.length; i++) {
                    derivative -= i * cashFlows[i] / Math.pow(1 + rate, i + 1);
                }
                return derivative;
            }

            displayResults(tir, tipoMercado, van, cashFlows, tipoMercadoDecimal) {
                // Mostrar TIR
                document.getElementById('tirResult').textContent = (tir * 100).toFixed(2) + '%';

                // Mostrar tipo de mercado
                document.getElementById('mercadoResult').textContent = tipoMercado.toFixed(2) + '%';

                // Mostrar VAN
                const vanElement = document.getElementById('vanResult');
                vanElement.textContent = '‚Ç¨' + van.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                vanElement.className = 'result-value ' + (van >= 0 ? 'positive' : 'negative');

                // Comparaci√≥n
                this.displayComparison(tir * 100, tipoMercado, van);

                // Tabla de flujos de caja
                this.displayCashFlowTable(cashFlows, tipoMercadoDecimal);

                this.resultsDiv.style.display = 'block';
                document.getElementById('scenariosSection').style.display = 'block';
                document.getElementById('sensitivitySection').style.display = 'block';
            }

            displayScenarios(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado) {
                const scenariosGrid = document.getElementById('scenariosGrid');
                scenariosGrid.innerHTML = '';

                // Definir escenarios
                const scenarios = [
                    {
                        name: 'Optimista',
                        class: 'optimista',
                        icon: 'üìà',
                        rentaMultiplier: 1.2,
                        valorMultiplier: 1.3,
                        description: 'Rentas +20%, Valor final +30%'
                    },
                    {
                        name: 'Realista',
                        class: 'realista',
                        icon: 'üìä',
                        rentaMultiplier: 1.0,
                        valorMultiplier: 1.0,
                        description: 'Valores introducidos (base)'
                    },
                    {
                        name: 'Pesimista',
                        class: 'pesimista',
                        icon: 'üìâ',
                        rentaMultiplier: 0.8,
                        valorMultiplier: 0.7,
                        description: 'Rentas -20%, Valor final -30%'
                    }
                ];

                scenarios.forEach(scenario => {
                    const rentaEscenario = rentaAnual * scenario.rentaMultiplier;
                    const valorEscenario = valorFinal * scenario.valorMultiplier;

                    const cashFlows = this.buildCashFlows(inversionInicial, rentaEscenario, numeroAnios, valorEscenario);

                    try {
                        const tir = this.calculateTIR(cashFlows);
                        const van = this.calculateNPV(cashFlows, tipoMercado);

                        const card = document.createElement('div');
                        card.className = `scenario-card ${scenario.class}`;

                        const diferencia = (tir * 100) - (tipoMercado * 100);
                        let estado = '';
                        if (diferencia > 0.5) estado = '‚úÖ Excelente';
                        else if (diferencia > 0) estado = '‚úÖ Buena';
                        else if (diferencia > -0.5) estado = '‚ö†Ô∏è Marginal';
                        else estado = '‚ùå No recomendada';

                        card.innerHTML = `
                            <div class="scenario-title">${scenario.icon} ${scenario.name}</div>
                            <div class="scenario-tir">${(tir * 100).toFixed(2)}%</div>
                            <div><strong>VAN:</strong> ‚Ç¨${van.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div><strong>vs. Mercado:</strong> ${diferencia > 0 ? '+' : ''}${diferencia.toFixed(2)}pp</div>
                            <div><strong>${estado}</strong></div>
                            <div class="scenario-details">${scenario.description}</div>
                        `;

                        scenariosGrid.appendChild(card);
                    } catch (error) {
                        const card = document.createElement('div');
                        card.className = `scenario-card ${scenario.class}`;
                        card.innerHTML = `
                            <div class="scenario-title">${scenario.icon} ${scenario.name}</div>
                            <div class="scenario-tir">Error</div>
                            <div>No se puede calcular TIR</div>
                            <div class="scenario-details">${scenario.description}</div>
                        `;
                        scenariosGrid.appendChild(card);
                    }
                });
            }

            displaySensitivityAnalysis(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado) {
                const sensitivityTable = document.getElementById('sensitivityTable');
                sensitivityTable.innerHTML = '';

                // Variaciones a analizar
                const variaciones = [-30, -20, -10, -5, 0, 5, 10, 20, 30];
                let rentaEquilibrio = null;

                variaciones.forEach(variacion => {
                    const nuevaRenta = rentaAnual * (1 + variacion / 100);
                    const cashFlows = this.buildCashFlows(inversionInicial, nuevaRenta, numeroAnios, valorFinal);

                    try {
                        const tir = this.calculateTIR(cashFlows);
                        const diferencia = (tir * 100) - (tipoMercado * 100);

                        const row = sensitivityTable.insertRow();
                        if (variacion === 0) {
                            row.className = 'center-row';
                        } else if (diferencia > 0) {
                            row.className = 'sensitivity-positive';
                        } else {
                            row.className = 'sensitivity-negative';
                        }

                        // Variaci√≥n
                        const varCell = row.insertCell(0);
                        varCell.textContent = variacion > 0 ? `+${variacion}%` : `${variacion}%`;

                        // Nueva renta
                        const rentaCell = row.insertCell(1);
                        rentaCell.textContent = '‚Ç¨' + nuevaRenta.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

                        // TIR
                        const tirCell = row.insertCell(2);
                        tirCell.textContent = (tir * 100).toFixed(2) + '%';

                        // vs Mercado
                        const diffCell = row.insertCell(3);
                        diffCell.textContent = (diferencia > 0 ? '+' : '') + diferencia.toFixed(2) + 'pp';

                        // Estado
                        const statusCell = row.insertCell(4);
                        if (diferencia > 0.5) statusCell.textContent = '‚úÖ Excelente';
                        else if (diferencia > 0) statusCell.textContent = '‚úÖ Rentable';
                        else if (diferencia > -0.5) statusCell.textContent = '‚ö†Ô∏è Marginal';
                        else statusCell.textContent = '‚ùå No rentable';

                        // Calcular punto de equilibrio
                        if (!rentaEquilibrio && diferencia >= 0) {
                            rentaEquilibrio = nuevaRenta;
                        }

                    } catch (error) {
                        const row = sensitivityTable.insertRow();
                        row.insertCell(0).textContent = variacion > 0 ? `+${variacion}%` : `${variacion}%`;
                        row.insertCell(1).textContent = '‚Ç¨' + nuevaRenta.toLocaleString('es-ES', { minimumFractionDigits: 0 });
                        row.insertCell(2).textContent = 'Error';
                        row.insertCell(3).textContent = '-';
                        row.insertCell(4).textContent = 'No calculable';
                    }
                });

                // Mostrar informaci√≥n de equilibrio
                this.displayEquilibriumInfo(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado, rentaEquilibrio);
            }

            displayEquilibriumInfo(inversionInicial, rentaAnual, numeroAnios, valorFinal, tipoMercado, rentaEquilibrio) {
                const equilibriumInfo = document.getElementById('equilibriumInfo');

                // Calcular renta exacta para igualar el tipo del mercado
                let rentaExacta = null;
                try {
                    rentaExacta = this.calculateBreakEvenRent(inversionInicial, numeroAnios, valorFinal, tipoMercado);
                } catch (error) {
                    // Si no se puede calcular exactamente
                }

                const reduccionNecesaria = ((rentaAnual - (rentaEquilibrio || rentaExacta || 0)) / rentaAnual * 100);

                equilibriumInfo.innerHTML = `
                    <h4>üéØ Punto de Equilibrio</h4>
                    <p><strong>Renta m√≠nima para igualar el mercado:</strong> ‚Ç¨${(rentaExacta || rentaEquilibrio || 0).toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</p>
                    <p><strong>Margen de seguridad:</strong> ${reduccionNecesaria > 0 ? `Las rentas pueden bajar hasta un ${reduccionNecesaria.toFixed(1)}% y seguir siendo rentables` : 'La inversi√≥n necesita rentas superiores para ser rentable'}</p>
                    <p><strong>Renta actual:</strong> ‚Ç¨${rentaAnual.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} - ${reduccionNecesaria > 0 ? '‚úÖ Por encima del equilibrio' : '‚ùå Por debajo del equilibrio'}</p>
                `;
            }

            calculateBreakEvenRent(inversionInicial, numeroAnios, valorFinal, tipoMercado) {
                // Calcular la renta exacta que hace que el TIR = tipo del mercado
                // VAN = 0 cuando TIR = tipo del mercado

                const rate = tipoMercado;
                let totalPV = inversionInicial; // Lo que necesitamos recuperar

                // Restar el valor presente del valor final
                totalPV -= valorFinal / Math.pow(1 + rate, numeroAnios);

                // Calcular el valor presente de una anualidad
                const annuityPV = (1 - Math.pow(1 + rate, -numeroAnios)) / rate;

                // La renta necesaria
                return totalPV / annuityPV;
            }

            displayComparison(tir, tipoMercado, van) {
                const comparisonDiv = document.getElementById('comparison');
                const comparisonText = document.getElementById('comparisonText');

                const diferencia = tir - tipoMercado;

                if (diferencia > 0.5) {
                    comparisonDiv.className = 'comparison positive';
                    comparisonText.textContent = `‚úÖ Excelente inversi√≥n: El TIR (${tir.toFixed(2)}%) supera al tipo del mercado en ${diferencia.toFixed(2)} puntos porcentuales. VAN positivo de ‚Ç¨${van.toLocaleString('es-ES', { minimumFractionDigits: 2 })}.`;
                } else if (diferencia > 0) {
                    comparisonDiv.className = 'comparison positive';
                    comparisonText.textContent = `‚úÖ Buena inversi√≥n: El TIR (${tir.toFixed(2)}%) supera ligeramente al tipo del mercado. VAN positivo de ‚Ç¨${van.toLocaleString('es-ES', { minimumFractionDigits: 2 })}.`;
                } else if (diferencia > -0.5) {
                    comparisonDiv.className = 'comparison neutral';
                    comparisonText.textContent = `‚ö†Ô∏è Inversi√≥n marginal: El TIR (${tir.toFixed(2)}%) es muy similar al tipo del mercado. Evaluar otros factores.`;
                } else {
                    comparisonDiv.className = 'comparison negative';
                    comparisonText.textContent = `‚ùå Inversi√≥n no recomendada: El TIR (${tir.toFixed(2)}%) est√° por debajo del tipo del mercado. VAN negativo de ‚Ç¨${van.toLocaleString('es-ES', { minimumFractionDigits: 2 })}.`;
                }
            }

            displayCashFlowTable(cashFlows, tipoMercado) {
                const tableBody = document.getElementById('cashFlowTable');
                tableBody.innerHTML = '';

                cashFlows.forEach((flow, index) => {
                    const row = tableBody.insertRow();

                    // A√±o
                    const yearCell = row.insertCell(0);
                    yearCell.textContent = index;

                    // Flujo de caja
                    const flowCell = row.insertCell(1);
                    flowCell.textContent = '‚Ç¨' + flow.toLocaleString('es-ES', { minimumFractionDigits: 2 });
                    flowCell.className = flow < 0 ? 'negative' : 'positive';

                    // Valor presente
                    const presentValue = flow / Math.pow(1 + tipoMercado, index);
                    const pvCell = row.insertCell(2);
                    pvCell.textContent = '‚Ç¨' + presentValue.toLocaleString('es-ES', { minimumFractionDigits: 2 });
                    pvCell.className = presentValue < 0 ? 'negative' : 'positive';
                });
            }

            showError(message) {
                this.errorDiv.textContent = message;
                this.errorDiv.style.display = 'block';
                this.resultsDiv.style.display = 'none';
            }

            hideError() {
                this.errorDiv.style.display = 'none';
            }
        }

        // Inicializar calculadora cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            new TIRCalculator();
        });
    </script>

    <!-- Footer meskeIA -->
    <footer style="position: fixed; bottom: 10px; right: 20px; color: #2d3748; font-size: 0.9rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: rgba(255, 255, 255, 0.9); padding: 5px 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        ¬© 2025 meskeIA
    </footer>
</body>
</html>